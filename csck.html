<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
	<title>Connected Scatterplot Construction Kit</title>
	<script type="text/javascript" src="datasets/army.js"></script>
	<script type="text/javascript" src="datasets/drivingsafety.js"></script>
	<script type="text/javascript" src="datasets/helium.js"></script>
	<script type="text/javascript" src="datasets/scorpion.js"></script>
	<script type="text/javascript" src="datasets/yellen.js"></script>
	<script type="text/javascript" src="datasets/threepoints.js"></script>
	<script type="text/javascript" src="datasets/steamship.js"></script>
	<script type="text/javascript" src="datasets/sofa.js"></script>
	<script type="text/javascript" src="datasets/sofa2.js"></script>
	<script type="text/javascript" src="datasets/china.js"></script>
	<style>

		body {
			font: 13px sans-serif;
			width: 1220px;
		}

		rect {
			fill: none;
			pointer-events: all;
		}

		circle,
		line,
		.line {
			fill: none;
			stroke: purple;
			stroke-width: 1.5px;
		}

		circle {
			fill: white;
			cursor: move;
		}

		.line1 {
			stroke: blue;
		}

		.line2 {
			stroke: green;
		}

		.selected {
			fill: #ff7f0e;
			stroke: #ff7f0e;
		}

		div#charts {
			width: 1220px;
			height: 600px;
			margin-bottom: 10px;
		}

		div.chart {
			width: 600px;
			height: 600px;
			float: left;
		}

		div#linechart {
			/*border-right: 1px solid black;*/
		}

		line.grid1, line.grid2, line.grid {
			stroke: lightgray;
		}

	</style>
	<script src="d3.v3.min.js"></script>
	<script>

		var width = 600,
		    height = 600;

		// var points = d3.range(1960, 2000, 10).map(function(i) {
		// 	return { date: i,
		// 			 value1: 50 + Math.random() * (height - 100),
		// 			 value2: 50 + Math.random() * (height - 100)
		// 			};
		// });

		var points = drivingsafety;

		var showArrows = false;
		var showDots = true;

		var timeScale = d3.scale.linear()
			.range([5, width-5]);

		var xScale = d3.scale.linear()
			.range([10, width-10]);

		var yScale = d3.scale.linear()
			.range([height-10, 10]);

		var draggedIndex = -1,
		    selectedIndex = -1;

		var lineConnected = d3.svg.line()
		    .x(function(d) { return xScale(d.value1); })
		    .y(function(d) { return yScale(d.value2); })
		    .interpolate('cardinal');

		var lineDA1 = d3.svg.line()
			.x(function(d) { return timeScale(d.date); })
			.y(function(d) { return height-xScale(d.value1); })
			.interpolate('cardinal');

		var lineDA2 = d3.svg.line()
			.x(function(d) { return timeScale(d.date); })
			.y(function(d) { return yScale(d.value2); })
			.interpolate('cardinal');


		var parallelCurves = [];
		var offsetCurves = [];
		var outOfPhaseCurves = [];
		var freqCurves = [];
		var spiral = [];

		function makeDataSets() {
			var d = new Date();
			for (var i = 0; i < 13; i += .3) {
				var p = {
					date: d,
					value1: Math.sin(i),
					value2: Math.sin(i)
				}
				parallelCurves.unshift(p);

				p = {
					date: d,
					value1: Math.sin(i),
					value2: Math.sin(i+1)
				}
				offsetCurves.unshift(p);

				p = {
					date: d,
					value1: Math.sin(i),
					value2: Math.cos(i)
				}
				outOfPhaseCurves.unshift(p);

				p = {
					date: d,
					value1: Math.sin(i),
					value2: Math.cos(i*1.5)
				}
				freqCurves.unshift(p);

				d = new Date(d.getTime()+24*3600*1000);
			}

			d = new Date();
			for (var i = 0; i < 40; i += .3) {
				var p = {
					date: d,
					value1: Math.sin(i)*(40-i),
					value2: Math.cos(i)*(40-i)
				}
				spiral.unshift(p);

				d = new Date(d.getTime()+24*3600*1000);
			}
		}


		var svgConnected;
		var svgDualAxes;

		var blueCircles;
		var greenCircles;

		function initialSetup() {

			makeDataSets();

			scaleScales();

			// Dual-Axes Line Chart

			svgDualAxes = d3.select('#linechart').append('svg')
				.attr('width', width)
				.attr('height', height)
				.attr('tabindex', 1);

			svgDualAxes.append('path')
				.datum(points)
				.attr('class', 'line line1');

			svgDualAxes.append('path')
				.datum(points)
				.attr('class', 'line line2');

			redrawDualAxes(true);

			// Connected Scatterplot

			svgConnected = d3.select('#connectedscatter').append('svg')
			    .attr('width', width)
			    .attr('height', height)
			    .attr('tabindex', 2);

			// marker triangle from http://www.w3.org/TR/SVG/painting.html#Markers
			svgConnected.append('defs')
				.append('marker')
				.attr('id', 'arrow')
				.attr('viewBox', '0 0 10 6')
				.attr('refX', 10)
				.attr('refY', 3)
				.attr('markerUnits', 'strokeWidth')
				.attr('markerWidth', 8)
				.attr('markerHeight', 5)
				.attr('orient', 'auto')
				.attr('stroke', 'none')
				.attr('fill', 'purple')
				.append('polygon')
					.attr('points', '0,0 10,3 0,6');

			svgConnected.append('line')
				.attr('x1', 0)
				.attr('x2', width)
				.attr('y1', height-1)
				.attr('y2', height-1)
				.attr('class', 'line1');

			svgConnected.append('line')
				.attr('x1', 1)
				.attr('x2', 1)
				.attr('y1', 0)
				.attr('y2', height)
				.attr('class', 'line2');

			svgConnected.append('rect')
			    .attr('width', width)
			    .attr('height', height);

			svgConnected.append('path')
				.datum(points)
				.attr('class', 'line')
				.attr('marker-mid', showArrows?'url(#arrow)':'none')
				.attr('marker-end', showArrows?'url(#arrow)':'none');

			d3.select(window)
			    .on('mousemove', mousemove)
			    .on('mouseup', mouseup);

			d3.select('#dataset').on('change', loadData);

			redraw(true);
		}

		function scaleScales() {
			points.forEach(function (d) {
				d.date = new Date(d.date);
			});

			timeScale.domain([points[0].date, points[points.length-1].date]);
			xScale.domain(d3.extent(points, function(d) { return d.value1; }));
			yScale.domain(d3.extent(points, function(d) { return d.value2; }));
		}

		function redrawConnected(recreate) {
			svgConnected.select('path').attr('d', lineConnected);

			if (recreate) {

				if (showDots) {

					var circle = svgConnected.selectAll('circle')
						.data(points);

					circle.enter().append('circle')
						.attr('r', 3)
						.on('mousedown', function(d, i) { selectedIndex = draggedIndex = i; redraw(false); });

					circle
						.classed('selected', function(d, i) { return i === selectedIndex; })
						.attr('cx', function(d) { return xScale(d.value1); })
						.attr('cy', function(d) { return yScale(d.value2); });

					circle.exit().remove();
				} else {
					svgConnected.selectAll('circle').remove();
				}
			} else {
				svgConnected.selectAll('circle')
					.data(points)
					.classed('selected', function(d, i) { return i === selectedIndex; })
					.attr('cx', function(d) { return xScale(d.value1); })
					.attr('cy', function(d) { return yScale(d.value2); });
			}

			if (d3.event) {
				d3.event.preventDefault();
				d3.event.stopPropagation();
			}
		}

		function redrawDualAxes(recreate) {
			svgDualAxes.select('path.line1').attr('d', lineDA1);
			svgDualAxes.select('path.line2').attr('d', lineDA2);
			if (recreate) {
				if (showDots) {
					blueCircles = svgDualAxes.selectAll('circle.line1')
						.data(points);

					blueCircles.enter().append('circle')
						.attr('r', 3)
						.attr('class', 'line1')
						.on('mousedown', function(d, i) { selectedIndex = draggedIndex = i; redraw(false); });

					blueCircles
						.classed('selected', function(d, i) { return i === selectedIndex; })
						.attr('cx', function(d) { return timeScale(d.date); })
						.attr('cy', function(d) { return height-xScale(d.value1); });

					greenCircles = svgDualAxes.selectAll('circle.line2')
						.data(points);

					greenCircles.enter().append('circle')
						.attr('r', 3)
						.attr('class', 'line2')
						.on('mousedown', function(d, i) { selectedIndex = draggedIndex = i; redraw(false); });

					greenCircles
						.classed('selected', function(d, i) { return i === selectedIndex; })
						.attr('cx', function(d) { return timeScale(d.date); })
						.attr('cy', function(d) { return yScale(d.value2); });
				} else {
					blueCircles.remove();
					greenCircles.remove();
				}
			} else {
				blueCircles
					.data(points)
					.classed('selected', function(d, i) { return i === selectedIndex; })
					.attr('cy', function(d) { return height-xScale(d.value1); });
				greenCircles
					.data(points)
					.classed('selected', function(d, i) { return i === selectedIndex; })
					.attr('cy', function(d) { return yScale(d.value2); });
			}
		}

		function redraw(recreate) {
			redrawConnected(recreate);
			redrawDualAxes(recreate);
		}

		function mousemove() {
			if (draggedIndex < 0) return;
			var m = d3.mouse(svgConnected.node());
			points[draggedIndex].value1 = xScale.invert(Math.max(0, Math.min(width, m[0])));
			points[draggedIndex].value2 = yScale.invert(Math.max(0, Math.min(height, m[1])));
			redraw(false);
		}

		function mouseup() {
			if (draggedIndex < 0) return;
			mousemove();
			draggedIndex = -1;
		}

		function toggleSmooth(checkbox) {
			if (checkbox.checked) {
				lineConnected.interpolate('cardinal');
				lineDA1.interpolate('cardinal');
				lineDA2.interpolate('cardinal');
			} else {
				lineConnected.interpolate('linear');
				lineDA1.interpolate('linear');
				lineDA2.interpolate('linear');
			}

			redraw(false);
		}

		function toggleArrows(checkbox) {
			showArrows = checkbox.checked;
			refreshLines(true);
		}

		function toggleDots(checkbox) {
			showDots = checkbox.checked;
			redraw(true);
		}

		function refreshLines() {

			svgDualAxes.select('path.line1')
				.datum(points);

			svgDualAxes.select('path.line2')
				.datum(points);

			svgConnected.select('path.line')
				.datum(points)
				.attr('marker-mid', showArrows?'url(#arrow)':'none')
				.attr('marker-end', showArrows?'url(#arrow)':'none');

			redraw(false);
		}

		function flipH() {
			var min = xScale.domain()[0];
			var max = xScale.domain()[1];
			points.forEach(function(d) {
				d.value1 = max-(d.value1-min);
			});
			refreshLines();
		}

		function flipV() {
			var min = yScale.domain()[0];
			var max = yScale.domain()[1];
			points.forEach(function(d) {
				d.value2 = max-(d.value2-min);
			});
			refreshLines();
		}


		function exchangeAxes() {
			points.forEach(function(d) {
				var temp = d.value1;
				d.value1 = xScale.invert(yScale(d.value2));
				d.value2 = yScale.invert(xScale(temp));
			});
		}

		function rotateCW() {
			exchangeAxes();
			flipH();
		}

		function rotateCCW() {
			exchangeAxes();
			flipV();
		}

		function loadData() {
			switch(this.value) {
				case 'army':
					points = army;
					break;
				case 'drivingsafety':
					points = drivingsafety;
					break;
				case 'helium':
					points = helium;
					break;
				case 'random':
					// regenerate random numbers
					break;
				case 'scorpion':
					points = scorpion;
					break;
				case 'yellen':
					points = yellen;
					break;
				case 'steamship':
					points = steamship;
					break;
				case 'sofa':
					points = sofa;
					break;
				case 'sofa2':
					points = sofa2;
					break;
				case 'china':
					points = china;
					break;
				case 'parallel':
					points = parallelCurves;
					break;
				case 'offset':
					points = offsetCurves;
					break;
				case 'outofphase':
					points = outOfPhaseCurves;
					break;
				case 'spiral':
					points = spiral;
					break;
				case 'frequency':
					points = freqCurves;
					break;
				case 'threepoints':
					points = threepoints;
					break;
			}

			scaleScales();

			refreshLines();
		}

	</script>
</head>
<body>
  <h1>Connected Scatterplot Construction Kit</h1>
  <div id="charts">
    <div id="linechart" class="chart"></div>
    <div id="connectedscatter" class="chart"></div>
  </div>
<div style="float:left;">
	<label><input type="checkbox" name="smooth" value="smooth" onclick="toggleSmooth(this);" checked /> Smooth</label>&nbsp;
	<label><input type="checkbox" name="arrows" value="arrows" onclick="toggleArrows(this);" /> Arrows</label>&nbsp;
	<label><input type="checkbox" name="dots" value="dots" onclick="toggleDots(this);" checked /> Dots</label>
</div>
<div style="float:right;">
	<button type="button" onclick="flipH();">Flip H</button>&nbsp;
	<button type="button" onclick="flipV();">Flip V</button>&nbsp;
	<button type="button" onclick="rotateCW();">Rotate CW</button>&nbsp;
	<button type="button" onclick="rotateCCW();">Rotate CCW</button>
</div>
<div style="clear:both;"></div>


<form>
	<label for="dataset">Dataset:</label>
	<select id="dataset">
		<option value="army">Army</option>
		<option value="drivingsafety" selected>Driving Safety</option>
		<option value="helium">Helium</option>
		<option value="scorpion">Unemployment/Scorpion</option>
		<option value="yellen">Yellen (cropped)</option>
		<option value="steamship">Steamship</option>
		<option value="sofa">Sofa vs. Couch</option>
		<option value="sofa2">Sofa vs. Couch v.2</option>
		<option value="china">China vs. Japan</option>
		<option value="parallel">Parallel Curves</option>
		<option value="offset">Offset Curves</option>
		<option value="outofphase">Out of Phase Curves</option>
		<option value="spiral">Spiral</option>
		<option value="frequency">Different Frequency</option>
		<option value="threepoints">Three Points</option>
	</select>
</form>

<!-- Based on <a href="http://bl.ocks.org/mbostock/4342190">Mike Bostock's Spline Editor example</a>. -->

<script type="text/javascript">
	initialSetup();
</script>
</body>
</html>
