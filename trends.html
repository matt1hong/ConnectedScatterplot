<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Compare Trends in Chart</title>
	<link rel="stylesheet" type="text/css" href="bootstrap.min.css">
	<link rel="stylesheet" href="csck.css">
	<script src="d3.v3.min.js"></script>
	<script type="text/javascript" src="queue.min.js"></script>
	<script type="text/javascript" src="common.js"></script>
	<script type="text/javascript" src="csck.js"></script>
	<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
	<script src="//code.jquery.com/jquery-1.11.0.js"></script>
	<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
	<style type="text/css">
div {
	margin: 0 auto;
	width: 600px;
}
#header {
	margin-top: 40px;
	font-size: 14px;
	height: 100px;
}
#study{
	display: none;
	text-align: center;
}
#wrong, #timed-out{
	display: none;
	color: red;
}
#continue{
	display: none;
}
	</style>
</head>
<body>
	<div id="header">
		<div class="tutorial" id="tutorial-1">
			<p>In this experiment, a chart will be shown.</p>
			<p>Each point represents two values: one on the horizontal axis, and one on the vertical axis.</p>
			<p>Two points that are adjacent across time are connected by an arrow.</p>
			<p>Press <b>s</b> or <b>d</b> to continue.</p>
			<div class="example">
				<img src="img/instructions.jpg"/>
			</div>
		</div>
		<div class="tutorial" id="tutorial-2">
			<p>At first, only the question will be shown.</p>
			<p>Then, click <b>s</b> or <b>d</b> to reveal the chart in question and start the timer.</p>
			<p>Pick the correct answer by pressing <b>s</b> (same) or <b>d</b> (different).</p>
			<p>Be as quick and accurate as you can.</p>
			<p>We will measure both correctness and speed.</p>
			<p>Press <b>s</b> or <b>d</b> to start practice.</p>
		</div>
		<div id="study">
			<p>The trends are:</p>
				<p>
					<p id='same' style="display: inline;">(<b>s</b>)ame</p> 
					/ 
					<p id='different' style="display: inline;">(<b>d</b>)ifferent</p>
				</p>
			<p id='wrong'>Your answer was incorrect. Timed out for 5 seconds...</p>
			<p id='timed-out'>That took more than t seconds. Please answer more quickly.</p>
			<p id='continue'>Press <b>s</b> or <b>d</b> to continue.</p>
		</div>
	</div>
	<div id="leftChart"></div>
	<div id="footer"></div>
	<script type="text/javascript">

$(function(){

var timeLimit = 10000;

var numTrials = 1;

//Number of segments being drawn
var numLines = 1;

//Classes
var Block = function(subjectID){
	this.subjectID = subjectID;
	this.trials = [];
};

var Trial = function(index, label1, label2, data, startYear){
	this.index = -1;
	this.label1 = '';
	this.label2 = '';
	this.data = [];
	this.startYear = '';
	this.highlight = false;
	this.response = null;
	this.responseTime = 0;
	this.result = null;
};

//Initial fake data
datasets = [{
	'label1': 'Number of Troops (thousands)', 
	'label2': 'Budget (billion $)', 
	'study': true, 
	'data': [
		{'date': "1/1/1948", 'value1':233, 'value2': 100},
		{'date': "1/1/1949", 'value1':100, 'value2': 400}
	]}];

//Stepping through the tutorial
var tutorialNow = 1;
var tutorialStep = function(event){
	var k = event.keyCode;

	if (k === 83 || k === 68) {
		if (tutorialNow < 2) {
			$('#tutorial-' + tutorialNow).hide();
			$('#tutorial-' + (tutorialNow + 1)).show();
		} 
		else {
			$('#tutorial-' + tutorialNow).hide();
			$(document).unbind("keyup", tutorialStep);
			runBlocks();
		}
		++tutorialNow;
	};
};

//To send results
var sendJSON = function(_block, callback) {
    // // strip out icon data
    // for (var t in _block.trials) {
    //     for (var d in _block.trials[t].data) {
    //         _block.trials[t].data[d].icons = [];
    //     }
    // }
    // // make sure version is set
    // _block.version = perfExperiment.version;
    // // show size of block data
    // console.log(encodeURIComponent(JSON.stringify(_block, null, " ")).length);

    // // get correctess and time
    // _block.avgRT = _block.trials.reduce(function (accumulator, trial) { return accumulator + trial.RT; }, 0) / _block.trials.length;
    // _block.avgCorrect = _block.trials.reduce(function (accumulator, trial) { return accumulator + trial.responseCorrect; }, 0) / _block.trials.length;

    // send
    var studyName = 'study1';
    console.log(_block)
    d3.xhr('submit-trends.php', 'application/x-www-form-urlencoded', callback)
        .header('content-type', 'application/x-www-form-urlencoded')
        .post('study=' + encodeURIComponent(studyName) + '&' +
            'subjectID=' + encodeURIComponent(_block.subjectID) + '&' +
            'data=' + encodeURIComponent(JSON.stringify(_block, null, " ")))
        .on('error', function (error) {
            console.log('ERROR: ' + error);
            if (typeof callback != "undefined")
                callback();
        });
};

var runBlocks = function(){
	/**
	* Run blocks
	*/

	var bl = new Block('000');

	for (var i = 0; i<numTrials; i++){
		//Initialize all trials first
		console.log(i)
		var trial = new Trial();
		trial.data = datasets[0].data;
		bl.trials.push(trial);
	};

	//Run each block
	var runBlock = function(block){
		/**
		* Deferred function
		*/
		var r = $.Deferred();

		for (var i = 0; i<numTrials; i++){
			var trial = block.trials[i];
			runTrial(trial);

			setTimeout(function(){
				//Reached time limit
				if (!trial.response) {
					//If no response yet
					$('#timed-out').show();
					$('#continue').css('color', 'red').show();
					// $(document).keyup(endTrial);
				}
				r.resolve();
			}, timeLimit);
		};

		return r;
	};

	//Send block when it finishes
	runBlock(bl).done(function(){sendJSON(bl);});
};

var runTrial = function(trial){
	/**
	* Run a trial
	*/

	//Time variables
	var delay = 3000;
	var penalty = 5000;

	var endTrial = function(event){
		/**
		* Callback to move on to the next trial
		*/
		k = event.keyCode;

		if (k === 83 || k === 68){
			return trial;
		}
	};

	var processResponse = function(event){
		/**
		* Callback processes keyboard input during trial
		* Evaluates answer and compares it with the response, computing the result
		* Sets the response and the result for the trial
		*/
		var k = event.keyCode;
		var data = datasets[0].data;
		var answer = (data[0]['value1'] - data[1]['value1'])/(data[0]['value2'] - data[1]['value2']) === 1;
		
		if (k === 83 || k === 68) {
			if (k === 83 && answer){
				// Correct and same
				$('#same').css('color', 'blue');
				$('#continue').css('color', 'blue').show();
				$(document).keyup(endTrial);
				trial.result = true;
			} else if (k === 68 && !answer){
				// Correct and different
				$('#different').css('color', 'blue');
				$('#continue').css('color', 'blue').show();
				$(document).keyup(endTrial);
				trial.result = true;
			} else {
				// Wrong
				$(document).keyup(null);
				if (answer){
					//Same
					$('#same').css('color', 'red');
					$('#different').css('color', 'blue');
				}else{
					//Different
					$('#different').css('color', 'blue');
					$('#same').css('color', 'red');
				}
				$('#wrong').show();
				// Enable continue after timeout
				setTimeout(function(){
					$('#wrong').hide();
					$('#continue').css('color', 'red').show();
					$(document).keyup(endTrial);
				}, penalty);
				trial.result = false;
			}
		}

		trial.response = k;
	};

	// Show question
	$('#study').show();
	// Show chart after delay
	setTimeout(function(){
		//Keyboard input
		$(document).keyup(processResponse);

		//Show chart
		initialSetup(false);

	}, delay);

};

interactDALC = false;
showArrows = true;
smoothLines = false;

$(document).keyup(tutorialStep);
$('#tutorial-1').show();

});
	</script>
</body>
</html>